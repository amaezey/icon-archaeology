#!/bin/bash
# Add new icons to the archive
# Usage: ./scripts/add /path/to/new/icons/

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Check for input
if [ -z "$1" ]; then
    echo "Usage: ./scripts/add /path/to/new/icons/"
    echo ""
    echo "Drag a folder onto Terminal after the command, or type the path."
    exit 1
fi

# Check folder exists
if [ ! -d "$1" ]; then
    echo "Error: $1 is not a folder"
    exit 1
fi

# Count PNGs
PNG_COUNT=$(find "$1" -maxdepth 1 -name "*.png" | wc -l | tr -d ' ')
if [ "$PNG_COUNT" -eq 0 ]; then
    echo "Error: No PNG files found in $1"
    exit 1
fi

echo "Found $PNG_COUNT PNG files"

# Check dependencies
if ! python3 -c "import anthropic, PIL, imagehash" 2>/dev/null; then
    echo "Installing dependencies..."
    pip3 install anthropic pillow imagehash -q
fi

# Check API key
if [ -z "$ANTHROPIC_API_KEY" ]; then
    # Try to load from .env or keychain
    if [ -f "$HOME/.anthropic_key" ]; then
        export ANTHROPIC_API_KEY=$(cat "$HOME/.anthropic_key")
    else
        echo "Error: ANTHROPIC_API_KEY not set"
        echo ""
        echo "Either:"
        echo "  export ANTHROPIC_API_KEY=sk-ant-..."
        echo "  or save key to ~/.anthropic_key"
        exit 1
    fi
fi

# Run the Python script
cd "$PROJECT_DIR"
python3 scripts/add_icons.py "$1"

echo ""
echo "Done! Refresh the gallery to see new icons."
