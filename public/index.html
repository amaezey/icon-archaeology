<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Icon Archive</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    @font-face {
      font-family: 'ChicagoFLF';
      src: url('fonts/ChicagoFLF.ttf') format('truetype');
    }

    * { box-sizing: border-box; }

    /* Remove blue selection highlight */
    ::selection {
      background: #000;
      color: #fff;
    }

    input::selection {
      background: #000;
      color: #fff;
    }

    :root {
      --window-bezel:
        1px 2px #111,
        inset 1px 1px 0px 0px #fff,
        inset -1px -1px 0px 0px #999;
      --inner-bezel:
        -1px -1px 0px 0px #999,
        1px 1px 0px 0px #fff,
        inset 1px 1px 0px 0px #fff,
        inset -1px -1px 0px 0px #999;
      --button-bezel:
        inset -1px -1px 0px 0px #777,
        inset -2px -2px 0px 0px #aaa,
        inset 1px 1px 0px 0px #ddd,
        inset 2px 2px 0px 0px #fff;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-image: url("img/patterns/128.png");
      background-repeat: repeat;
      font-family: 'ChicagoFLF', Geneva, 'Lucida Grande', sans-serif;
      font-size: 12px;
    }

    .window {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      bottom: 20px;
      border: 1px solid #111;
      background: #ccc;
      box-shadow: var(--window-bezel);
      display: flex;
      flex-direction: column;
    }

    .title-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 2px 4px;
      background:
        repeating-linear-gradient(
          to bottom,
          #fff 0px,
          #fff 1px,
          #bbb 1px,
          #bbb 2px
        );
      border-bottom: 1px solid #999;
      height: 20px;
    }

    .title-bar .controls {
      display: flex;
      gap: 8px;
      background: #ccc;
      padding: 0 2px;
    }

    .control-box {
      width: 13px;
      height: 13px;
      border: 1px solid #000;
      background: #fff;
      box-shadow: inset -1px -1px 0 #999, inset 1px 1px 0 #fff;
    }

    .title-bar h1 {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      font-weight: normal;
      margin: 0;
      background: #ccc;
      padding: 0 8px;
    }

    .toolbar {
      padding: 8px;
      background: #ccc;
      border-bottom: 1px solid #999;
    }

    .search-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    input[type="text"] {
      font-family: inherit;
      font-size: 12px;
      padding: 3px 6px;
      border: 1px solid #000;
      background: #fff;
      box-shadow: inset 1px 1px 0 #999;
      width: 200px;
    }

    .stats {
      margin-left: auto;
      font-size: 11px;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
      align-items: center;
    }

    .filter-label {
      font-size: 11px;
      color: #333;
    }

    .tag {
      font-family: inherit;
      font-size: 10px;
      padding: 2px 6px;
      border: 1px solid #000;
      background: #ddd;
      box-shadow: var(--button-bezel);
      cursor: pointer;
    }

    .tag:hover { background: #eee; }

    .tag:active, .tag.active {
      background: #bbb;
      box-shadow: inset 1px 1px 2px rgba(0,0,0,0.4);
    }

    .tag.unavailable {
      opacity: 0.4;
    }

    .tag .count { opacity: 0.6; font-size: 9px; }

    .toggle-btn {
      font-family: inherit;
      font-size: 9px;
      padding: 2px 5px;
      border: 1px solid #666;
      background: #ccc;
      cursor: pointer;
    }

    .color-swatch-btn {
      width: 18px;
      height: 18px;
      border: 1px solid #000;
      cursor: pointer;
      padding: 0;
      margin: 2px;
    }

    .color-swatch-btn:hover {
      outline: 1px solid #000;
    }
    .color-swatch-btn.active {
      box-shadow: inset 2px 2px 3px rgba(0,0,0,0.5);
      outline: 2px solid #000;
    }

    .color-swatch-btn.unavailable {
      opacity: 0.4;
    }

    .clear-btn {
      font-family: inherit;
      font-size: 11px;
      padding: 8px 12px;
      align-self: stretch;
      border: 1px solid #000;
      background: #ddd;
      box-shadow: var(--button-bezel);
      cursor: pointer;
    }

    .clear-btn:active {
      background: #bbb;
      box-shadow: inset 1px 1px 2px rgba(0,0,0,0.4);
    }

    .sort-label {
      font-size: 11px;
    }

    .custom-select {
      position: relative;
      font-family: inherit;
      font-size: 11px;
      min-width: 70px;
    }

    .select-selected {
      padding: 2px 20px 2px 6px;
      border: 1px solid #000;
      background: #ddd url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="8" height="4"><path d="M0 0h8L4 4z" fill="%23000"/></svg>') right 6px center no-repeat;
      box-shadow: var(--button-bezel);
      cursor: pointer;
      height: 20px;
      line-height: 14px;
    }

    .select-selected:hover { background-color: #eee; }

    .select-items {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      border: 1px solid #000;
      background: #fff;
      box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
      z-index: 100;
      display: none;
    }

    .custom-select.open .select-items { display: block; }

    .select-items div {
      padding: 2px 6px;
      cursor: pointer;
    }

    .select-items div:hover {
      background: #000;
      color: #fff;
    }

    /* Category icon palette */
    .category-palette {
      display: flex;
      gap: 2px;
      padding: 4px;
      background: #fff;
      border: 1px solid #888;
      box-shadow: inset 1px 1px 0 #666;
    }

    .category-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 4px 8px 2px;
      cursor: pointer;
      background: transparent;
      border: none;
      font-family: inherit;
      font-size: 9px;
    }

    .category-btn img {
      width: 32px;
      height: 32px;
      image-rendering: pixelated;
      margin-bottom: 2px;
    }

    .category-btn .label { padding: 1px 3px; }

    .category-btn.active {
      background: #bbb;
      box-shadow: inset 1px 1px 2px rgba(0,0,0,0.4);
    }

    .category-btn.active .label {
      background: #000;
      color: #fff;
    }

    .pagination {
      display: flex;
      gap: 0;
      align-items: center;
    }

    .page-number-display {
      font-family: inherit;
      font-size: 11px;
      min-width: 20px;
      height: 15px;
      border-top: 1px solid #000;
      border-bottom: 1px solid #000;
      background: #fff;
      text-align: center;
      line-height: 13px;
      box-shadow: inset 1px 0 0 #888;
    }

    .page-arrow {
      width: 15px;
      height: 15px;
      border: 1px solid #000;
      background: #ddd;
      box-shadow: inset -1px -1px 0 #888, inset 1px 1px 0 #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .page-arrow svg {
      width: 6px;
      height: 8px;
    }

    .page-arrow:hover { background: #eee; }
    .page-arrow:disabled {
      background: #ccc;
      box-shadow: inset -1px -1px 0 #aaa, inset 1px 1px 0 #ddd;
      cursor: default;
    }
    .page-arrow:disabled svg { opacity: 0.4; }
    .page-arrow:active:not(:disabled) { box-shadow: inset 1px 1px 2px #000; }

    /* Mac OS 8 scrollbar */
    .content-area::-webkit-scrollbar {
      width: 16px;
      height: 16px;
    }

    .content-area::-webkit-scrollbar-track {
      background: #ccc;
      border-left: 1px solid #999;
    }

    .content-area::-webkit-scrollbar-thumb {
      background: #ddd;
      border: 1px solid #000;
      box-shadow: inset -1px -1px 0 #999, inset 1px 1px 0 #fff;
    }

    .content-area::-webkit-scrollbar-thumb:hover {
      background: #eee;
    }

    .content-area::-webkit-scrollbar-button {
      background: #ddd;
      border: 1px solid #000;
      box-shadow: inset -1px -1px 0 #999, inset 1px 1px 0 #fff;
      height: 16px;
      width: 16px;
    }

    .content-area::-webkit-scrollbar-button:vertical:decrement {
      background: #ddd url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8"><path d="M4 2L1 6h6z" fill="%23000"/></svg>') center no-repeat;
    }

    .content-area::-webkit-scrollbar-button:vertical:increment {
      background: #ddd url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8"><path d="M4 6L1 2h6z" fill="%23000"/></svg>') center no-repeat;
    }

    .content-area::-webkit-scrollbar-corner {
      background: #ccc;
    }

    .content-area {
      flex: 1;
      overflow: auto;
      margin: 4px;
      padding: 8px;
      background: #fff;
      border: 1px solid #000;
      box-shadow: inset 1px 1px 0 #999;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 4px;
    }

    .icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 6px 4px;
      cursor: pointer;
      border: 1px solid transparent;
    }

    .icon:hover {
      background: #ddd;
      border: 1px dotted #000;
    }

    .icon.selected {
      background: #000;
      color: #fff;
    }

    .icon.selected .name { color: #fff; }

    .icon img {
      width: 32px;
      height: 32px;
      image-rendering: pixelated;
    }

    .icon .name {
      font-size: 9px;
      text-align: center;
      margin-top: 4px;
      max-width: 90px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      line-height: 1.2;
      max-height: 2.4em;
    }

    .loading, .empty {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px;
      color: #666;
    }

    #detail {
      position: fixed;
      bottom: 40px;
      right: 40px;
      width: 240px;
      border: 1px solid #111;
      background: #ccc;
      box-shadow: var(--window-bezel);
      display: none;
    }

    #detail.visible { display: block; }

    #detail .title-bar {
      padding: 2px 4px;
      cursor: default;
    }

    #detail .detail-content {
      margin: 4px;
      padding: 8px;
      background: #fff;
      border: 1px solid #000;
      box-shadow: inset 1px 1px 0 #999;
    }

    #detail img {
      width: 64px;
      height: 64px;
      image-rendering: pixelated;
      display: block;
      margin: 0 auto 8px;
    }

    #detail .name {
      font-weight: bold;
      font-size: 11px;
      margin-bottom: 4px;
      word-break: break-all;
      text-align: center;
    }

    #detail .description {
      font-style: italic;
      font-size: 11px;
      text-align: center;
      margin-bottom: 8px;
      color: #333;
    }

    #detail .detail-row {
      font-size: 10px;
      margin-bottom: 2px;
    }

    #detail .detail-row span:first-child { color: #666; }

    #detail .colors {
      display: flex;
      gap: 4px;
      margin-top: 6px;
      justify-content: center;
    }

    #detail .color-swatch {
      width: 16px;
      height: 16px;
      border: 1px solid #000;
    }

    #detail .breadcrumb {
      font-size: 9px;
      color: #666;
      margin-bottom: 8px;
      text-align: center;
    }

    #detail .download-link {
      display: block;
      text-align: center;
      margin-top: 8px;
      font-size: 10px;
      padding: 3px 8px;
      background: #ddd;
      border: 1px solid #000;
      box-shadow: var(--button-bezel);
      text-decoration: none;
      color: #000;
    }

    #detail .download-link:hover {
      background: #eee;
    }

    .status-bar {
      padding: 2px 8px;
      background: #ccc;
      border-top: 1px solid #fff;
      font-size: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .window {
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border: none;
        box-shadow: none;
      }

      .toolbar {
        padding: 6px;
      }

      .search-row {
        flex-wrap: wrap;
        gap: 6px;
      }

      input[type="text"] {
        width: 100%;
        order: -1;
      }

      .stats {
        margin-left: auto;
      }

      .status-bar {
        font-size: 9px;
      }

      .page-arrow {
        width: 14px;
        height: 14px;
      }

      .page-number-display {
        min-width: 18px;
        height: 14px;
        font-size: 10px;
        line-height: 12px;
      }

      .category-palette {
        flex-wrap: wrap;
        gap: 4px;
      }

      .category-btn {
        padding: 3px 6px 2px;
      }

      .category-btn img {
        width: 24px;
        height: 24px;
      }

      .filters {
        gap: 4px;
        margin-bottom: 4px;
      }

      .filter-label {
        width: 100%;
        margin-bottom: 2px;
      }

      .tag {
        font-size: 9px;
        padding: 2px 4px;
      }

      .color-swatch-btn {
        width: 16px;
        height: 16px;
      }

      .grid {
        grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        gap: 2px;
      }

      .icon {
        padding: 4px 2px;
      }

      .icon .name {
        font-size: 8px;
      }

      #detail {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        max-height: 50vh;
        overflow-y: auto;
      }

      .title-bar h1 {
        font-size: 11px;
      }

      .control-box {
        width: 11px;
        height: 11px;
      }
    }

    @media (max-width: 480px) {
      .custom-select {
        font-size: 10px;
        min-width: 60px;
      }

      .select-selected {
        padding: 2px 16px 2px 4px;
        height: 18px;
        line-height: 12px;
      }

      .clear-btn {
        font-size: 9px;
        padding: 6px 8px;
      }

      .category-btn img {
        width: 20px;
        height: 20px;
      }

      .category-btn .label {
        font-size: 8px;
      }

      .grid {
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      }

      .icon img {
        width: 28px;
        height: 28px;
      }
    }
  </style>
</head>
<body>
  <div class="window">
    <div class="title-bar">
      <div class="controls">
        <div class="control-box"></div>
      </div>
      <h1>Icon Archive</h1>
      <div class="controls">
        <div class="control-box"></div>
        <div class="control-box"></div>
      </div>
    </div>

    <div class="toolbar">
      <div class="search-row">
        <input type="text" id="search" placeholder="Search...">
        <span class="sort-label">Sort:</span>
        <div class="custom-select" id="sort-select">
          <div class="select-selected">A–Z</div>
          <div class="select-items">
            <div data-value="name-asc">A–Z</div>
            <div data-value="name-desc">Z–A</div>
            <div data-value="newest">Newest</div>
            <div data-value="oldest">Oldest</div>
          </div>
        </div>
        <div class="stats">
          <span id="count">0</span> / <span id="total">0</span> icons
        </div>
      </div>
      <div class="filters">
        <span class="filter-label">Category:</span>
        <div class="category-palette" id="category-filters"></div>
        <button class="clear-btn" id="clear-filters">Reset Filters</button>
      </div>
      <div class="filters">
        <span class="filter-label">Tags:</span>
        <div class="filter-group" id="tag-filters"></div>
      </div>
      <div class="filters">
        <span class="filter-label">Color:</span>
        <div class="filter-group" id="color-filters"></div>
      </div>
    </div>

    <div class="content-area">
      <div class="grid" id="grid">
        <div class="loading">Loading icons...</div>
      </div>
    </div>

    <div class="status-bar">
      <span id="status-text">Ready</span>
      <div class="pagination" id="pagination"></div>
    </div>
  </div>

  <div id="detail">
    <div class="title-bar">
      <h1>Info</h1>
    </div>
    <div class="detail-content">
      <img src="" alt="">
      <div class="name"></div>
      <div class="description"></div>
      <div class="breadcrumb"></div>
      <div class="detail-row"><span>Category: </span><span class="primary-val"></span></div>
      <div class="detail-row"><span>Tags: </span><span class="tags-val"></span></div>
      <div class="colors"></div>
      <a class="download-link" href="" download>Download</a>
    </div>
  </div>

  <script>
    const ICONS_BASE = 'icons';
    const TAGS_FILE = 'tags.json';

    let tagsData = null;
    // Multi-select: Sets for categories, tags, colors
    let activeFilters = {
      categories: new Set(),
      tags: new Set(),
      colors: new Set()
    };
    const expandedGroups = { tags: false };
    let currentPage = 1;
    const PAGE_SIZE = 500;

    // Category icons mapping
    const CATEGORY_ICONS = {
      'object': 'icons/afternoon-tea---sweets--short-cake-1.png',
      'character': 'icons/alive--bunny.png',
      'symbol': 'icons/heart---16455.png',
      'ui': 'icons/-regis-millenium--finder.png',
      'text': 'icons/classic-x--text.png'
    };

    function countValues(field, isArray = false, minCount = 1) {
      const counts = {};
      tagsData.icons.forEach(icon => {
        if (isArray) {
          (icon[field] || []).forEach(val => {
            if (val) counts[val] = (counts[val] || 0) + 1;
          });
        } else {
          const val = icon[field];
          if (val) counts[val] = (counts[val] || 0) + 1;
        }
      });
      return Object.entries(counts)
        .sort((a, b) => b[1] - a[1])
        .filter(([_, count]) => count >= minCount);
    }

    async function loadTags() {
      try {
        const response = await fetch(TAGS_FILE);
        tagsData = await response.json();
        document.getElementById('total').textContent = tagsData.icons.length.toLocaleString();
        document.getElementById('status-text').textContent = 'Loaded ' + tagsData.icons.length + ' icons';
        buildFilters();
        render();
      } catch (e) {
        document.getElementById('grid').textContent = 'Could not load tags.json';
      }
    }

    function buildFilters() {
      buildCategoryPalette();
      buildTagFilters();
      buildColorFilters();
    }

    function buildCategoryPalette() {
      const container = document.getElementById('category-filters');
      container.replaceChildren();

      const categories = ['object', 'character', 'symbol', 'ui', 'text'];

      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'category-btn';
        if (activeFilters.categories.has(cat)) btn.classList.add('active');

        const img = document.createElement('img');
        img.src = CATEGORY_ICONS[cat];
        img.alt = cat;

        const label = document.createElement('span');
        label.className = 'label';
        label.textContent = cat;

        btn.appendChild(img);
        btn.appendChild(label);

        btn.onclick = () => {
          if (activeFilters.categories.has(cat)) {
            activeFilters.categories.delete(cat);
            btn.classList.remove('active');
          } else {
            activeFilters.categories.add(cat);
            btn.classList.add('active');
          }
          currentPage = 1;
          render();
        };

        container.appendChild(btn);
      });
    }

    function buildTagFilters() {
      const container = document.getElementById('tag-filters');
      container.replaceChildren();

      // Count unique icons per tag (deduped across themes and vibes)
      const allTags = {};
      tagsData.icons.forEach(icon => {
        // Dedupe tags for this icon - may appear in both themes and vibes
        const iconTags = new Set([
          ...(icon.themes || icon.secondary || []),
          ...(icon.vibes || [icon.vibe]).filter(Boolean)
        ]);
        iconTags.forEach(t => {
          if (t) allTags[t] = (allTags[t] || 0) + 1;
        });
      });

      const sortedTags = Object.entries(allTags)
        .sort((a, b) => b[1] - a[1])
        .filter(([_, count]) => count >= 10);

      const expanded = expandedGroups.tags;
      const initialCount = 20;
      const visibleTags = expanded ? sortedTags : sortedTags.slice(0, initialCount);

      visibleTags.forEach(([tag, count]) => {
        const btn = document.createElement('button');
        btn.className = 'tag';
        btn.dataset.tag = tag;
        if (activeFilters.tags.has(tag)) btn.classList.add('active');
        btn.textContent = tag;

        const countSpan = document.createElement('span');
        countSpan.className = 'count';
        countSpan.textContent = ' (' + count + ')';
        btn.appendChild(countSpan);

        btn.onclick = () => {
          if (activeFilters.tags.has(tag)) {
            activeFilters.tags.delete(tag);
            btn.classList.remove('active');
          } else {
            activeFilters.tags.add(tag);
            btn.classList.add('active');
          }
          currentPage = 1;
          render();
        };

        container.appendChild(btn);
      });

      if (sortedTags.length > initialCount) {
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'toggle-btn';
        toggleBtn.textContent = expanded ? 'less' : '+' + (sortedTags.length - initialCount);
        toggleBtn.onclick = () => {
          expandedGroups.tags = !expandedGroups.tags;
          buildTagFilters();
        };
        container.appendChild(toggleBtn);
      }
    }

    function buildColorFilters() {
      const container = document.getElementById('color-filters');
      container.replaceChildren();

      // Count colors
      const colorCounts = {};
      tagsData.icons.forEach(icon => {
        (icon.colors || []).forEach(color => {
          if (color) colorCounts[color] = (colorCounts[color] || 0) + 1;
        });
      });

      // Sort by count and take top colors
      const topColors = Object.entries(colorCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 16);

      topColors.forEach(([color, count]) => {
        const btn = document.createElement('button');
        btn.className = 'color-swatch-btn';
        btn.dataset.color = color;
        if (activeFilters.colors.has(color)) btn.classList.add('active');
        btn.style.background = color;
        btn.title = color + ' (' + count + ')';
        btn.onclick = () => {
          if (activeFilters.colors.has(color)) {
            activeFilters.colors.delete(color);
            btn.classList.remove('active');
          } else {
            activeFilters.colors.add(color);
            btn.classList.add('active');
          }
          currentPage = 1;
          render();
        };
        container.appendChild(btn);
      });
    }

    function clearFilters() {
      activeFilters = {
        categories: new Set(),
        tags: new Set(),
        colors: new Set()
      };
      document.querySelectorAll('.tag.active, .color-swatch-btn.active, .category-btn.active').forEach(t => t.classList.remove('active'));
      document.getElementById('search').value = '';
      currentPage = 1;
      render();
    }

    function updateFilterCounts(filteredIcons) {
      // Count tags among filtered icons
      const tagCounts = {};
      const colorCounts = {};

      filteredIcons.forEach(icon => {
        // Dedupe tags - an icon may have same tag in both themes and vibes
        const iconTags = new Set([
          ...(icon.themes || icon.secondary || []),
          ...(icon.vibes || [icon.vibe]).filter(Boolean)
        ]);
        iconTags.forEach(t => {
          if (t) tagCounts[t] = (tagCounts[t] || 0) + 1;
        });

        (icon.colors || []).forEach(c => {
          if (c) colorCounts[c] = (colorCounts[c] || 0) + 1;
        });
      });

      // Update tag buttons
      document.querySelectorAll('.tag[data-tag]').forEach(btn => {
        const tag = btn.dataset.tag;
        const count = tagCounts[tag] || 0;
        const countSpan = btn.querySelector('.count');
        if (countSpan) {
          countSpan.textContent = ' (' + count + ')';
        }
        btn.classList.toggle('unavailable', count === 0 && !activeFilters.tags.has(tag));
      });

      // Update color buttons
      document.querySelectorAll('.color-swatch-btn[data-color]').forEach(btn => {
        const color = btn.dataset.color;
        const count = colorCounts[color] || 0;
        btn.title = color + ' (' + count + ')';
        btn.classList.toggle('unavailable', count === 0 && !activeFilters.colors.has(color));
      });
    }

    function getDisplayName(icon) {
      // Priority: display_name > description > parsed filename
      if (icon.display_name && icon.display_name.trim()) return icon.display_name;
      if (icon.description && icon.description.trim()) return icon.description;

      // Fallback: parse from filename
      let name = icon.file.replace('.png', '');
      name = name.replace(/---?\d+$/, '').replace(/--item-icon$/, '');

      if (name.includes('--')) {
        const parts = name.split('--');
        for (let i = parts.length - 1; i >= 0; i--) {
          if (parts[i] && !/^-+$/.test(parts[i])) {
            name = parts[i];
            break;
          }
        }
      }

      name = name.replace(/^-+/, '').replace(/-+$/, '');
      name = name.replace(/[-_]+/g, ' ').trim();

      if (!name || /^\d+$/.test(name)) return '?';
      return name;
    }

    function createIconCard(icon) {
      const div = document.createElement('div');
      div.className = 'icon';

      const img = document.createElement('img');
      img.src = ICONS_BASE + '/' + icon.file;
      img.alt = icon.file;
      img.loading = 'lazy';

      const name = document.createElement('div');
      name.className = 'name';
      name.textContent = getDisplayName(icon);
      name.title = icon.description || (icon.path ? icon.path.join(' / ') : icon.file);

      div.appendChild(img);
      div.appendChild(name);
      div.onclick = () => showDetail(icon, div);
      return div;
    }

    function showDetail(icon, element) {
      document.querySelectorAll('.icon.selected').forEach(el => el.classList.remove('selected'));
      if (element) element.classList.add('selected');

      const detail = document.getElementById('detail');
      const imgSrc = ICONS_BASE + '/' + icon.file;
      detail.querySelector('img').src = imgSrc;
      detail.querySelector('.name').textContent = getDisplayName(icon);
      detail.querySelector('.description').textContent = icon.description || '';
      detail.querySelector('.breadcrumb').textContent = icon.path ? icon.path.join(' > ') : (icon.collection || '');
      detail.querySelector('.primary-val').textContent = icon.category || icon.primary;
      const allTags = [
        ...(icon.themes || icon.secondary || []),
        ...(icon.vibes || [icon.vibe]).filter(Boolean)
      ];
      const uniqueTags = [...new Set(allTags)];
      detail.querySelector('.tags-val').textContent = uniqueTags.join(', ') || 'none';

      const colorsDiv = detail.querySelector('.colors');
      colorsDiv.replaceChildren();
      (icon.colors || []).forEach(color => {
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        swatch.style.background = color;
        swatch.title = color;
        colorsDiv.appendChild(swatch);
      });

      // Download link
      detail.querySelector('.download-link').href = imgSrc;
      detail.querySelector('.download-link').download = (icon.display_name || getDisplayName(icon)) + '.png';

      detail.classList.add('visible');
    }

    let currentSort = 'name-asc';

    function sortIcons(icons) {
      const sortBy = currentSort;

      if (sortBy === 'newest') {
        return [...icons].reverse();
      }
      if (sortBy === 'oldest') {
        return [...icons];
      }

      return [...icons].sort((a, b) => {
        let aVal, bVal, direction = 1;

        switch (sortBy) {
          case 'name-asc':
            aVal = (a.display_name || a.description || a.file).toLowerCase();
            bVal = (b.display_name || b.description || b.file).toLowerCase();
            break;
          case 'name-desc':
            aVal = (a.display_name || a.description || a.file).toLowerCase();
            bVal = (b.display_name || b.description || b.file).toLowerCase();
            direction = -1;
            break;
          default:
            aVal = a.file;
            bVal = b.file;
        }
        return direction * aVal.localeCompare(bVal);
      });
    }

    function renderPagination(totalItems) {
      const container = document.getElementById('pagination');
      container.replaceChildren();

      const totalPages = Math.max(1, Math.ceil(totalItems / PAGE_SIZE));

      // Mac OS 8 style pagination - always show
      const prevBtn = document.createElement('button');
      prevBtn.className = 'page-arrow';
      const prevSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      prevSvg.setAttribute('viewBox', '0 0 6 8');
      const prevPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      prevPath.setAttribute('d', 'M6 0L0 4L6 8z');
      prevPath.setAttribute('fill', '#000');
      prevSvg.appendChild(prevPath);
      prevBtn.appendChild(prevSvg);
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => { currentPage--; render(); };
      container.appendChild(prevBtn);

      const pageNum = document.createElement('div');
      pageNum.className = 'page-number-display';
      pageNum.textContent = currentPage;
      container.appendChild(pageNum);

      const nextBtn = document.createElement('button');
      nextBtn.className = 'page-arrow';
      const nextSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      nextSvg.setAttribute('viewBox', '0 0 6 8');
      const nextPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      nextPath.setAttribute('d', 'M0 0L6 4L0 8z');
      nextPath.setAttribute('fill', '#000');
      nextSvg.appendChild(nextPath);
      nextBtn.appendChild(nextSvg);
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = () => { currentPage++; render(); };
      container.appendChild(nextBtn);
    }

    function render() {
      if (!tagsData) return;

      const search = document.getElementById('search').value.toLowerCase();
      const grid = document.getElementById('grid');

      let filtered = tagsData.icons.filter(icon => {
        // Category filter (OR logic): icon must match at least one selected category
        if (activeFilters.categories.size > 0) {
          const iconCat = icon.category || icon.primary;
          if (!activeFilters.categories.has(iconCat)) return false;
        }

        // Tags filter (AND logic): icon must have ALL selected tags (from themes or vibes)
        if (activeFilters.tags.size > 0) {
          const iconTags = [
            ...(icon.themes || icon.secondary || []),
            ...(icon.vibes || [icon.vibe]).filter(Boolean)
          ];
          const hasAllTags = [...activeFilters.tags].every(t => iconTags.includes(t));
          if (!hasAllTags) return false;
        }

        // Color filter (AND logic): icon must have ALL selected colors
        if (activeFilters.colors.size > 0) {
          const iconColors = icon.colors || [];
          const hasAllColors = [...activeFilters.colors].every(c => iconColors.includes(c));
          if (!hasAllColors) return false;
        }

        if (search) {
          const haystack = [
            icon.file,
            icon.display_name || '',
            icon.collection || '',
            icon.category || icon.primary,
            ...(icon.vibes || [icon.vibe]),
            icon.description || '',
            ...(icon.themes || icon.secondary || []),
            ...(icon.colors || []),
            ...(icon.path || [])
          ].join(' ').toLowerCase();
          if (!haystack.includes(search)) return false;
        }

        return true;
      });

      // Sort
      filtered = sortIcons(filtered);

      // Pagination
      const totalPages = Math.ceil(filtered.length / PAGE_SIZE);
      if (currentPage > totalPages) currentPage = Math.max(1, totalPages);
      const start = (currentPage - 1) * PAGE_SIZE;
      const pageIcons = filtered.slice(start, start + PAGE_SIZE);

      grid.replaceChildren();

      if (filtered.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = 'No icons match your filters';
        grid.appendChild(empty);
      } else {
        pageIcons.forEach(icon => grid.appendChild(createIconCard(icon)));
      }

      renderPagination(filtered.length);
      document.getElementById('count').textContent = filtered.length.toLocaleString();
      document.getElementById('status-text').textContent = filtered.length + ' items';

      updateFilterCounts(filtered);
    }

    document.getElementById('search').addEventListener('input', () => { currentPage = 1; render(); });
    document.getElementById('clear-filters').addEventListener('click', clearFilters);

    // Custom sort dropdown
    const sortSelect = document.getElementById('sort-select');
    const sortSelected = sortSelect.querySelector('.select-selected');
    const sortItems = sortSelect.querySelector('.select-items');

    sortSelected.addEventListener('click', (e) => {
      e.stopPropagation();
      sortSelect.classList.toggle('open');
    });

    sortItems.addEventListener('click', (e) => {
      if (e.target.dataset.value) {
        currentSort = e.target.dataset.value;
        sortSelected.textContent = e.target.textContent;
        sortSelect.classList.remove('open');
        currentPage = 1;
        render();
      }
    });

    document.addEventListener('click', () => {
      sortSelect.classList.remove('open');
    });

    loadTags();
  </script>
</body>
</html>
