<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Icon Archive</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    @font-face {
      font-family: 'ChicagoFLF';
      src: url('fonts/ChicagoFLF.ttf') format('truetype');
    }

    * { box-sizing: border-box; }

    /* Remove blue selection highlight */
    ::selection {
      background: #000;
      color: #fff;
    }

    input::selection {
      background: #000;
      color: #fff;
    }

    :root {
      --window-bezel:
        1px 2px #111,
        inset 1px 1px 0px 0px #fff,
        inset -1px -1px 0px 0px #999;
      --inner-bezel:
        -1px -1px 0px 0px #999,
        1px 1px 0px 0px #fff,
        inset 1px 1px 0px 0px #fff,
        inset -1px -1px 0px 0px #999;
      --button-bezel:
        inset -1px -1px 0px 0px #777,
        inset -2px -2px 0px 0px #aaa,
        inset 1px 1px 0px 0px #ddd,
        inset 2px 2px 0px 0px #fff;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-image: url("img/patterns/128.png");
      background-repeat: repeat;
      font-family: 'ChicagoFLF', Geneva, 'Lucida Grande', sans-serif;
      font-size: 12px;
    }

    .window {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      bottom: 20px;
      border: 1px solid #111;
      background: #ccc;
      box-shadow: var(--window-bezel);
      display: flex;
      flex-direction: column;
    }

    .title-bar {
      display: flex;
      align-items: center;
      padding: 2px 4px;
      background: linear-gradient(to bottom, #fff 0%, #ccc 100%);
      border-bottom: 1px solid #999;
    }

    .title-bar .controls {
      display: flex;
      gap: 8px;
    }

    .control-box {
      width: 13px;
      height: 13px;
      border: 1px solid #000;
      background: #fff;
      box-shadow: inset -1px -1px 0 #999, inset 1px 1px 0 #fff;
    }

    .title-bar h1 {
      flex: 1;
      text-align: center;
      font-size: 12px;
      font-weight: normal;
      margin: 0;
    }

    .toolbar {
      padding: 8px;
      background: #ccc;
      border-bottom: 1px solid #999;
    }

    .search-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    input[type="text"] {
      font-family: inherit;
      font-size: 12px;
      padding: 3px 6px;
      border: 1px solid #000;
      background: #fff;
      box-shadow: inset 1px 1px 0 #999;
      width: 200px;
    }

    .stats {
      margin-left: auto;
      font-size: 11px;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
      align-items: center;
    }

    .filter-label {
      font-size: 11px;
      color: #333;
    }

    .tag {
      font-family: inherit;
      font-size: 10px;
      padding: 2px 6px;
      border: 1px solid #000;
      background: #ddd;
      box-shadow: var(--button-bezel);
      cursor: pointer;
    }

    .tag:hover { background: #eee; }

    .tag:active, .tag.active {
      background: #000;
      color: #fff;
      box-shadow: inset 1px 1px 2px #000;
    }

    .tag .count { opacity: 0.6; font-size: 9px; }

    .toggle-btn {
      font-family: inherit;
      font-size: 9px;
      padding: 2px 5px;
      border: 1px solid #666;
      background: #ccc;
      cursor: pointer;
    }

    .color-swatch-btn {
      width: 18px;
      height: 18px;
      border: 1px solid #000;
      cursor: pointer;
      padding: 0;
      margin: 2px;
    }

    .color-swatch-btn:hover {
      outline: 2px solid #000;
      outline-offset: 1px;
    }
    .color-swatch-btn.active {
      outline: 2px solid #000;
      outline-offset: 1px;
    }

    .clear-btn {
      font-family: inherit;
      font-size: 10px;
      padding: 2px 8px;
      border: 1px solid #000;
      background: #ddd;
      box-shadow: var(--button-bezel);
      cursor: pointer;
    }

    .sort-row {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .sort-label {
      font-size: 11px;
    }

    .sort-buttons {
      display: flex;
      gap: 2px;
    }

    .sort-btn {
      font-family: inherit;
      font-size: 10px;
      padding: 2px 6px;
      border: 1px solid #000;
      background: #ddd;
      box-shadow: var(--button-bezel);
      cursor: pointer;
    }

    .sort-btn:hover { background: #eee; }
    .sort-btn.active {
      background: #000;
      color: #fff;
      box-shadow: inset 1px 1px 2px #000;
    }

    .pagination {
      display: flex;
      gap: 0;
      align-items: center;
      justify-content: center;
      padding: 4px 8px;
      background: #ccc;
    }

    .page-arrow {
      font-family: inherit;
      font-size: 10px;
      width: 20px;
      height: 18px;
      border: 1px solid #000;
      background: #ddd;
      box-shadow: var(--button-bezel);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .page-arrow:hover { background: #eee; }
    .page-arrow:disabled { opacity: 0.5; cursor: default; }
    .page-arrow:active { box-shadow: inset 1px 1px 2px #000; }

    .page-number {
      font-family: inherit;
      font-size: 11px;
      min-width: 40px;
      height: 18px;
      border-top: 1px solid #000;
      border-bottom: 1px solid #000;
      background: #fff;
      text-align: center;
      line-height: 16px;
      box-shadow: inset 1px 1px 0 #999;
    }

    /* Mac OS 8 scrollbar */
    .content-area::-webkit-scrollbar {
      width: 16px;
      height: 16px;
    }

    .content-area::-webkit-scrollbar-track {
      background: #ccc;
      border-left: 1px solid #999;
    }

    .content-area::-webkit-scrollbar-thumb {
      background: #ddd;
      border: 1px solid #000;
      box-shadow: inset -1px -1px 0 #999, inset 1px 1px 0 #fff;
    }

    .content-area::-webkit-scrollbar-thumb:hover {
      background: #eee;
    }

    .content-area::-webkit-scrollbar-button {
      background: #ddd;
      border: 1px solid #000;
      box-shadow: inset -1px -1px 0 #999, inset 1px 1px 0 #fff;
      height: 16px;
      width: 16px;
    }

    .content-area::-webkit-scrollbar-button:vertical:decrement {
      background: #ddd url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8"><path d="M4 2L1 6h6z" fill="%23000"/></svg>') center no-repeat;
    }

    .content-area::-webkit-scrollbar-button:vertical:increment {
      background: #ddd url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="8" height="8"><path d="M4 6L1 2h6z" fill="%23000"/></svg>') center no-repeat;
    }

    .content-area::-webkit-scrollbar-corner {
      background: #ccc;
    }

    .content-area {
      flex: 1;
      overflow: auto;
      margin: 4px;
      padding: 8px;
      background: #fff;
      border: 1px solid #000;
      box-shadow: inset 1px 1px 0 #999;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 4px;
    }

    .icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 6px 4px;
      cursor: pointer;
      border: 1px solid transparent;
    }

    .icon:hover {
      background: #ddd;
      border: 1px dotted #000;
    }

    .icon.selected {
      background: #000;
      color: #fff;
    }

    .icon.selected .name { color: #fff; }

    .icon img {
      width: 32px;
      height: 32px;
      image-rendering: pixelated;
    }

    .icon .name {
      font-size: 9px;
      text-align: center;
      margin-top: 4px;
      max-width: 90px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      line-height: 1.2;
      max-height: 2.4em;
    }

    .loading, .empty {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px;
      color: #666;
    }

    #detail {
      position: fixed;
      bottom: 40px;
      right: 40px;
      width: 240px;
      border: 1px solid #111;
      background: #ccc;
      box-shadow: var(--window-bezel);
      display: none;
    }

    #detail.visible { display: block; }

    #detail .title-bar {
      padding: 2px 4px;
      cursor: default;
    }

    #detail .detail-content {
      margin: 4px;
      padding: 8px;
      background: #fff;
      border: 1px solid #000;
      box-shadow: inset 1px 1px 0 #999;
    }

    #detail img {
      width: 64px;
      height: 64px;
      image-rendering: pixelated;
      display: block;
      margin: 0 auto 8px;
    }

    #detail .name {
      font-weight: bold;
      font-size: 11px;
      margin-bottom: 4px;
      word-break: break-all;
      text-align: center;
    }

    #detail .description {
      font-style: italic;
      font-size: 11px;
      text-align: center;
      margin-bottom: 8px;
      color: #333;
    }

    #detail .detail-row {
      font-size: 10px;
      margin-bottom: 2px;
    }

    #detail .detail-row span:first-child { color: #666; }

    #detail .colors {
      display: flex;
      gap: 4px;
      margin-top: 6px;
      justify-content: center;
    }

    #detail .color-swatch {
      width: 16px;
      height: 16px;
      border: 1px solid #000;
    }

    #detail .breadcrumb {
      font-size: 9px;
      color: #666;
      margin-bottom: 8px;
      text-align: center;
    }

    #detail .download-link {
      display: block;
      text-align: center;
      margin-top: 8px;
      font-size: 10px;
      padding: 3px 8px;
      background: #ddd;
      border: 1px solid #000;
      box-shadow: var(--button-bezel);
      text-decoration: none;
      color: #000;
    }

    #detail .download-link:hover {
      background: #eee;
    }

    .status-bar {
      padding: 2px 8px;
      background: #ccc;
      border-top: 1px solid #fff;
      font-size: 10px;
      display: flex;
      justify-content: space-between;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .window {
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border: none;
        box-shadow: none;
      }

      .toolbar {
        padding: 6px;
      }

      .search-row {
        flex-wrap: wrap;
        gap: 6px;
      }

      input[type="text"] {
        width: 100%;
        order: -1;
      }

      .sort-row {
        width: 100%;
        flex-wrap: wrap;
      }

      .sort-buttons {
        flex-wrap: wrap;
      }

      .stats {
        width: 100%;
        text-align: right;
        margin-left: 0;
      }

      .filters {
        gap: 4px;
        margin-bottom: 4px;
      }

      .filter-label {
        width: 100%;
        margin-bottom: 2px;
      }

      .tag {
        font-size: 9px;
        padding: 2px 4px;
      }

      .color-swatch-btn {
        width: 16px;
        height: 16px;
      }

      .grid {
        grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        gap: 2px;
      }

      .icon {
        padding: 4px 2px;
      }

      .icon .name {
        font-size: 8px;
      }

      #detail {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        max-height: 50vh;
        overflow-y: auto;
      }

      .title-bar h1 {
        font-size: 11px;
      }

      .control-box {
        width: 11px;
        height: 11px;
      }
    }

    @media (max-width: 480px) {
      .sort-btn {
        font-size: 9px;
        padding: 2px 4px;
      }

      .clear-btn {
        font-size: 9px;
        padding: 2px 6px;
      }

      .grid {
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      }

      .icon img {
        width: 28px;
        height: 28px;
      }
    }
  </style>
</head>
<body>
  <div class="window">
    <div class="title-bar">
      <div class="controls">
        <div class="control-box"></div>
      </div>
      <h1>Icon Archive</h1>
      <div class="controls">
        <div class="control-box"></div>
        <div class="control-box"></div>
      </div>
    </div>

    <div class="toolbar">
      <div class="search-row">
        <input type="text" id="search" placeholder="Search...">
        <button class="clear-btn" id="clear-filters">Clear</button>
        <div class="sort-row">
          <span class="sort-label">Sort:</span>
          <div class="sort-buttons" id="sort-buttons">
            <button class="sort-btn active" data-sort="name">Name</button>
            <button class="sort-btn" data-sort="collection">Collection</button>
            <button class="sort-btn" data-sort="category">Category</button>
            <button class="sort-btn" data-sort="vibe">Vibe</button>
          </div>
        </div>
        <div class="stats">
          <span id="count">0</span> / <span id="total">0</span> icons
        </div>
      </div>
      <div class="filters">
        <span class="filter-label">Category:</span>
        <div class="filter-group" id="category-filters"></div>
      </div>
      <div class="filters">
        <span class="filter-label">Theme:</span>
        <div class="filter-group" id="theme-filters"></div>
      </div>
      <div class="filters">
        <span class="filter-label">Vibe:</span>
        <div class="filter-group" id="vibe-filters"></div>
      </div>
      <div class="filters">
        <span class="filter-label">Color:</span>
        <div class="filter-group" id="color-filters"></div>
      </div>
    </div>

    <div class="content-area">
      <div class="grid" id="grid">
        <div class="loading">Loading icons...</div>
      </div>
    </div>

    <div class="pagination" id="pagination"></div>

    <div class="status-bar">
      <span id="status-text">Ready</span>
      <span id="selected-name"></span>
    </div>
  </div>

  <div id="detail">
    <div class="title-bar">
      <h1>Info</h1>
    </div>
    <div class="detail-content">
      <img src="" alt="">
      <div class="name"></div>
      <div class="description"></div>
      <div class="breadcrumb"></div>
      <div class="detail-row"><span>Category: </span><span class="primary-val"></span></div>
      <div class="detail-row"><span>Theme: </span><span class="secondary-val"></span></div>
      <div class="detail-row"><span>Vibe: </span><span class="vibe-val"></span></div>
      <div class="colors"></div>
      <a class="download-link" href="" download>Download</a>
    </div>
  </div>

  <script>
    const ICONS_BASE = 'icons';
    const TAGS_FILE = 'tags.json';

    let tagsData = null;
    let activeFilters = { category: null, vibe: null, theme: null, color: null };
    const expandedGroups = { category: false, vibe: false, theme: false };
    let currentPage = 1;
    const PAGE_SIZE = 500;

    function countValues(field, isArray = false, minCount = 1) {
      const counts = {};
      tagsData.icons.forEach(icon => {
        if (isArray) {
          (icon[field] || []).forEach(val => {
            if (val) counts[val] = (counts[val] || 0) + 1;
          });
        } else {
          const val = icon[field];
          if (val) counts[val] = (counts[val] || 0) + 1;
        }
      });
      return Object.entries(counts)
        .sort((a, b) => b[1] - a[1])
        .filter(([_, count]) => count >= minCount);
    }

    async function loadTags() {
      try {
        const response = await fetch(TAGS_FILE);
        tagsData = await response.json();
        document.getElementById('total').textContent = tagsData.icons.length.toLocaleString();
        document.getElementById('status-text').textContent = 'Loaded ' + tagsData.icons.length + ' icons';
        buildFilters();
        render();
      } catch (e) {
        document.getElementById('grid').textContent = 'Could not load tags.json';
      }
    }

    function buildFilters() {
      buildFilterGroup('category', 'category-filters', 'category', false, 15);
      buildFilterGroup('vibes', 'vibe-filters', 'vibe', true, 10);
      buildFilterGroup('themes', 'theme-filters', 'theme', true, 15);
      buildColorFilters();
    }

    function buildColorFilters() {
      const container = document.getElementById('color-filters');
      container.replaceChildren();

      // Count colors
      const colorCounts = {};
      tagsData.icons.forEach(icon => {
        (icon.colors || []).forEach(color => {
          if (color) colorCounts[color] = (colorCounts[color] || 0) + 1;
        });
      });

      // Sort by count and take top colors
      const topColors = Object.entries(colorCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 16);

      topColors.forEach(([color, count]) => {
        const btn = document.createElement('button');
        btn.className = 'color-swatch-btn';
        if (activeFilters.color === color) btn.classList.add('active');
        btn.style.background = color;
        btn.title = color + ' (' + count + ')';
        btn.onclick = () => {
          if (activeFilters.color === color) {
            activeFilters.color = null;
            btn.classList.remove('active');
          } else {
            document.querySelectorAll('#color-filters .color-swatch-btn').forEach(b => b.classList.remove('active'));
            activeFilters.color = color;
            btn.classList.add('active');
          }
          currentPage = 1;
          render();
        };
        container.appendChild(btn);
      });
    }

    function buildFilterGroup(field, containerId, filterKey, isArray, initialCount) {
      const container = document.getElementById(containerId);
      container.replaceChildren();

      const allValues = countValues(field, isArray, 1);
      const expanded = expandedGroups[filterKey];
      const visibleValues = expanded ? allValues : allValues.slice(0, initialCount);

      visibleValues.forEach(([val, count]) => {
        const btn = document.createElement('button');
        btn.className = 'tag';
        if (activeFilters[filterKey] === val) btn.classList.add('active');
        btn.textContent = val;
        const countSpan = document.createElement('span');
        countSpan.className = 'count';
        countSpan.textContent = ' (' + count + ')';
        btn.appendChild(countSpan);
        btn.onclick = () => toggleFilter(filterKey, val, btn, containerId);
        container.appendChild(btn);
      });

      if (allValues.length > initialCount) {
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'toggle-btn';
        toggleBtn.textContent = expanded ? 'less' : '+' + (allValues.length - initialCount);
        toggleBtn.onclick = () => {
          expandedGroups[filterKey] = !expandedGroups[filterKey];
          buildFilterGroup(field, containerId, filterKey, isArray, initialCount);
        };
        container.appendChild(toggleBtn);
      }
    }

    function toggleFilter(type, value, btn, containerId) {
      if (activeFilters[type] === value) {
        activeFilters[type] = null;
        btn.classList.remove('active');
      } else {
        document.querySelectorAll('#' + containerId + ' .tag').forEach(t => t.classList.remove('active'));
        activeFilters[type] = value;
        btn.classList.add('active');
      }
      currentPage = 1;
      render();
    }

    function clearFilters() {
      activeFilters = { category: null, vibe: null, theme: null, color: null };
      document.querySelectorAll('.tag.active, .color-swatch-btn.active').forEach(t => t.classList.remove('active'));
      document.getElementById('search').value = '';
      currentPage = 1;
      render();
    }

    function getDisplayName(icon) {
      // Priority: display_name > description > parsed filename
      if (icon.display_name && icon.display_name.trim()) return icon.display_name;
      if (icon.description && icon.description.trim()) return icon.description;

      // Fallback: parse from filename
      let name = icon.file.replace('.png', '');
      name = name.replace(/---?\d+$/, '').replace(/--item-icon$/, '');

      if (name.includes('--')) {
        const parts = name.split('--');
        for (let i = parts.length - 1; i >= 0; i--) {
          if (parts[i] && !/^-+$/.test(parts[i])) {
            name = parts[i];
            break;
          }
        }
      }

      name = name.replace(/^-+/, '').replace(/-+$/, '');
      name = name.replace(/[-_]+/g, ' ').trim();

      if (!name || /^\d+$/.test(name)) return '?';
      return name;
    }

    function createIconCard(icon) {
      const div = document.createElement('div');
      div.className = 'icon';

      const img = document.createElement('img');
      img.src = ICONS_BASE + '/' + icon.file;
      img.alt = icon.file;
      img.loading = 'lazy';

      const name = document.createElement('div');
      name.className = 'name';
      name.textContent = getDisplayName(icon);
      name.title = icon.description || (icon.path ? icon.path.join(' / ') : icon.file);

      div.appendChild(img);
      div.appendChild(name);
      div.onclick = () => showDetail(icon, div);
      return div;
    }

    function showDetail(icon, element) {
      document.querySelectorAll('.icon.selected').forEach(el => el.classList.remove('selected'));
      if (element) element.classList.add('selected');

      const detail = document.getElementById('detail');
      const imgSrc = ICONS_BASE + '/' + icon.file;
      detail.querySelector('img').src = imgSrc;
      detail.querySelector('.name').textContent = getDisplayName(icon);
      detail.querySelector('.description').textContent = icon.description || '';
      detail.querySelector('.breadcrumb').textContent = icon.path ? icon.path.join(' > ') : (icon.collection || '');
      detail.querySelector('.primary-val').textContent = icon.category || icon.primary;
      detail.querySelector('.secondary-val').textContent = (icon.themes || icon.secondary || []).join(', ') || 'none';
      detail.querySelector('.vibe-val').textContent = (icon.vibes || [icon.vibe]).join(', ') || 'none';

      const colorsDiv = detail.querySelector('.colors');
      colorsDiv.replaceChildren();
      (icon.colors || []).forEach(color => {
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        swatch.style.background = color;
        swatch.title = color;
        colorsDiv.appendChild(swatch);
      });

      // Download link
      detail.querySelector('.download-link').href = imgSrc;
      detail.querySelector('.download-link').download = (icon.display_name || getDisplayName(icon)) + '.png';

      detail.classList.add('visible');
      document.getElementById('selected-name').textContent = getDisplayName(icon);
    }

    let currentSort = 'name';

    function sortIcons(icons) {
      const sortBy = currentSort;
      return [...icons].sort((a, b) => {
        let aVal, bVal;
        switch (sortBy) {
          case 'name':
            aVal = (a.display_name || a.description || a.file).toLowerCase();
            bVal = (b.display_name || b.description || b.file).toLowerCase();
            break;
          case 'collection':
            aVal = (a.collection || '').toLowerCase();
            bVal = (b.collection || '').toLowerCase();
            break;
          case 'category':
            aVal = (a.category || a.primary || '').toLowerCase();
            bVal = (b.category || b.primary || '').toLowerCase();
            break;
          case 'vibe':
            aVal = ((a.vibes || [a.vibe])[0] || '').toLowerCase();
            bVal = ((b.vibes || [b.vibe])[0] || '').toLowerCase();
            break;
          default:
            aVal = a.file;
            bVal = b.file;
        }
        return aVal.localeCompare(bVal);
      });
    }

    function renderPagination(totalItems) {
      const container = document.getElementById('pagination');
      container.replaceChildren();

      const totalPages = Math.ceil(totalItems / PAGE_SIZE);
      if (totalPages <= 1) return;

      // Mac OS 8 style: ◁ | page | ▷
      const prevBtn = document.createElement('button');
      prevBtn.className = 'page-arrow';
      prevBtn.textContent = '◁';
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => { currentPage--; render(); };
      container.appendChild(prevBtn);

      const pageNum = document.createElement('div');
      pageNum.className = 'page-number';
      pageNum.textContent = currentPage;
      container.appendChild(pageNum);

      const nextBtn = document.createElement('button');
      nextBtn.className = 'page-arrow';
      nextBtn.textContent = '▷';
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = () => { currentPage++; render(); };
      container.appendChild(nextBtn);
    }

    function render() {
      if (!tagsData) return;

      const search = document.getElementById('search').value.toLowerCase();
      const grid = document.getElementById('grid');

      let filtered = tagsData.icons.filter(icon => {
        if (activeFilters.category && (icon.category || icon.primary) !== activeFilters.category) return false;
        if (activeFilters.vibe && !(icon.vibes || [icon.vibe]).includes(activeFilters.vibe)) return false;
        if (activeFilters.theme && !(icon.themes || icon.secondary || []).includes(activeFilters.theme)) return false;
        if (activeFilters.color && !(icon.colors || []).includes(activeFilters.color)) return false;

        if (search) {
          const haystack = [
            icon.file,
            icon.display_name || '',
            icon.collection || '',
            icon.category || icon.primary,
            ...(icon.vibes || [icon.vibe]),
            icon.description || '',
            ...(icon.themes || icon.secondary || []),
            ...(icon.colors || []),
            ...(icon.path || [])
          ].join(' ').toLowerCase();
          if (!haystack.includes(search)) return false;
        }

        return true;
      });

      // Sort
      filtered = sortIcons(filtered);

      // Pagination
      const totalPages = Math.ceil(filtered.length / PAGE_SIZE);
      if (currentPage > totalPages) currentPage = Math.max(1, totalPages);
      const start = (currentPage - 1) * PAGE_SIZE;
      const pageIcons = filtered.slice(start, start + PAGE_SIZE);

      grid.replaceChildren();

      if (filtered.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = 'No icons match your filters';
        grid.appendChild(empty);
      } else {
        pageIcons.forEach(icon => grid.appendChild(createIconCard(icon)));
      }

      renderPagination(filtered.length);
      document.getElementById('count').textContent = filtered.length.toLocaleString();
      document.getElementById('status-text').textContent = filtered.length + ' items';
    }

    document.getElementById('search').addEventListener('input', () => { currentPage = 1; render(); });
    document.getElementById('clear-filters').addEventListener('click', clearFilters);

    // Sort buttons
    document.getElementById('sort-buttons').addEventListener('click', (e) => {
      if (e.target.classList.contains('sort-btn')) {
        document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        currentSort = e.target.dataset.sort;
        currentPage = 1;
        render();
      }
    });

    loadTags();
  </script>
</body>
</html>
